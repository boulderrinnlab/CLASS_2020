---
title: "Enrichment of factors on reservoirs"
output: html_document
editor_options: 
  chunk_output_type: console
---

``` {r setup, include=FALSE}
options(stringsAsFactors = FALSE)
knitr::opts_chunk$set(echo = TRUE)
source("../util/intersect_functions.R")
source("../util/_setup.R")
library(GenomicRanges)
library(tidyverse)
library(effectsize)
library(regioneR)
```


Some of these results don't make sense in the last chunck of enrichment of mRNA vs lncRNA 
How come egfp-ZNF507 didn't come up in the previous plots 
I think we just need some consistency with the text in outputs -- simple :)
Or I am simply confusing that BRCA1 and ZNF507 both bind mRNA and lncNRA more than permutation chance. But bind to lncRNAs more than mRNA promoters when comparing the peak counts on these promoters in observed space.


# Also missing the slope plots of mRNA vs lncRNA binding events? It's all in 02_ permutations -- we may want to dissect out the mRNA vs lncRNA aspects to be consistent with the text.

```{r}
# Import peaks
consensus_peaks <- import_peaks("/Shares/rinn_class/data/CLASS_2020/analysis/01_consensus_peaks/results/consensus_peaks/")
# Import gencode
lncrna_promoters <- rtracklayer::import("../01_consensus_peaks/results/lncrna_promoters.gtf")
mrna_promoters <- rtracklayer::import("../01_consensus_peaks/results/mrna_promoters.gtf")

lncrna_matrix <- count_peaks_per_feature(lncrna_promoters, peak_list, type = "occurrence")
mrna_matrix <- count_peaks_per_feature(mrna_promoters, peak_list, type = "occurrence")
```

# Total peak count vs. Number of promoter overlaps -- mRNA vs lncRNA

# This plots the number of overlaps with lncRNA and mRNA promoter
```{r}
# Check that the order is the same.
stopifnot(all(names(consensus_peaks) == rownames(lncrna_matrix)))
num_peaks_df <- data.frame("dbp" = rownames(lncrna_matrix),
                           "total_number_of_peaks" = sapply(consensus_peaks, length),
                           "lncrna" = rowSums(lncrna_matrix),
                           "mrna" = rowSums(mrna_matrix))



num_peaks_dfl <- num_peaks_df %>% 
  pivot_longer(lncrna:mrna, 
               names_to = "promoter_type",
               values_to = "peaks_overlapping_promoters")


#TODO Not sure what is being plotted here 
ggplot(num_peaks_dfl,
       aes(x = total_number_of_peaks, y = peaks_overlapping_promoters, color = promoter_type)) +
  scale_color_manual(values = c("#424242", "#a8404c"))+
  xlab("Peaks per TF") +
  ylab("Peaks Overlapping Promoters") +
  ggtitle("Relationship Between Number of TF Peaks and Promoter Overlaps")+
  # geom_point() +
  geom_abline(slope = 1, linetype="dashed") +
  geom_smooth(method = "lm", se=TRUE) + 
  stat_regline_equation() +
  stat_cor(label.y = c(1000, 2000), label.x = 50000)
ggsave("figures/peaks_overlaps_relationship.png", height = 5, width = 8)
ggsave("figures/peaks_overlaps_relationship.pdf", height = 5, width = 8)
```

# Permutation test of promoter overlaps -- mRNA vs lncRNA

```{r}
perm_res_promoters <- read_csv("../02_permutation_of_consensus_peaks/results/permutation_results_promoters.csv")
```

Nearly all DBPs were enriched on both lncRNA and mRNA promoters. A few however, were significantly depleted.
eGFP-ZNF507: depleted on both mRNA and lncRNA promoters -- BRCA1 was only depelted on mRNA promoters and was neither enriched or depleted for lncRNA promoters over random chance.

```{r promoter-depletion, fig.width=7, fig.height=10}
depleted_on_promoters <- perm_res_promoters %>% filter(alternative == "less", padj <= 0.01)

plot_perm_test <- function(row, df) {
  region <- df$region[row]
  dbp <- df$tf[row]
  observed <- df$observed[row]
  permuted <- df$permuted[row]
  padj <- round(df$padj[row],4)
  nperm <- df$nperm[row]
  df <- data.frame("region" = region, 
                   "dbp" = dbp, 
                   "permuted" = permuted) %>%
    separate_rows(permuted, sep = ";", convert = T)
  g <- ggplot(df, aes(x = permuted)) + 
    geom_histogram(bins = 30) +
    geom_vline(xintercept = observed, lty = 2) +
    ggtitle(paste0(region, " -- ", dbp),
            subtitle = paste0("padj = ", padj, " nperms = ", nperm))
  return(g)
}
pl <- lapply(1:nrow(depleted_on_promoters), plot_perm_test, df = depleted_on_promoters)
gridExtra::grid.arrange(grobs = pl, ncol = 1)
```

TODO: Depleted on promoters:

`r paste(paste(depleted_on_promoters$region, depleted_on_promoters$tf, sep = "-"), collapse = " ")`

#TODO Somehting seems odd BRCA1 is that is more enriched on lncRNA vs mRNA but in general BRCA1 binds to lncRNA and mRNA promoters more than expected by permutations
And a few were neither enriched or depleted.
Thus, some proteins bind equally to mRNA and lncRNA promoters BRCA1 would have to be one of these cases based on above.
Where it was found to be enriched on 

```{r, fig.width=7, fig.height=13}
ns_promoters <- perm_res_promoters %>% filter(padj > 0.01)
pl <- lapply(1:nrow(ns_promoters), plot_perm_test, df = ns_promoters)
gridExtra::grid.arrange(grobs = pl, ncol = 1)
```

Not significant:

`r paste(paste(ns_promoters$region, ns_promoters$tf, sep = "-"), collapse = " ")`

# lncRNA vs mRNA binding enrichment
TODO: make figure stretch out a bit more and have more of a volcano plot feel

```{r}
lncrna_num_overlaps <- rowSums(lncrna_matrix)
mrna_num_overlaps <- rowSums(mrna_matrix)
num_peaks <- sapply(peak_list, length)
total_lncrna <- length(lncrna_promoters)
total_mrna <- length(mrna_promoters)
total_genes <- total_lncrna + total_mrna
chisq_res <- data.frame("tf" =character(),
                        "lncrna_peaks_observed" = numeric(),
                        "chisq_stat" = numeric(),
                        "chisq_pval" = numeric(),
                        "lncrna_peaks_expected" = numeric())
for(i in 1:length(num_peaks)) {
  total_peaks <- num_peaks[[i]]
  df1 <- data.frame("gene_type" = c("lncRNA","lncRNA", "mRNA", "mRNA"),
                    "promoter_bound" = c("bound", "not_bound", "bound", "not_bound"),
                    "count" = c(lncrna_num_overlaps[[i]],
                                total_lncrna - lncrna_num_overlaps[[i]],
                                mrna_num_overlaps[[i]],
                                total_mrna - mrna_num_overlaps[[i]])) %>%
    pivot_wider(names_from = gene_type, values_from = count) %>%
    column_to_rownames("promoter_bound") %>%
    as.matrix()
  
  csres <- chisq.test(df1)
  
  # TODO add phi calculation; r package effectsize 
  
  phi_coef <- phi(df1)
  
  tdf <- data.frame("tf" = names(num_peaks[i]),
                    "lncrna_peaks_observed" = lncrna_num_overlaps[[i]],
                    "chisq_stat" = csres$statistic,
                    "chisq_pval" = csres$p.value,
                    "lncrna_peaks_expected" = csres$expected[1,1],
                    "phi_coefficient" = phi_coef$phi)
  chisq_res <- bind_rows(chisq_res, tdf)
}

chisq_res$padj <- p.adjust(chisq_res$chisq_pval, method = "BH")
chisq_res$diff <- chisq_res$lncrna_peaks_observed - chisq_res$lncrna_peaks_expected
write_csv(chisq_res, "results/lncrna_vs_mrna_chisq_results.csv")

# full lncRNA promoter occupancy plot
g <- ggplot(chisq_res, aes(x = diff, y = -log10(chisq_pval) ))
g + geom_point()  


# zoom in plot 
g2 <- ggplot(chisq_res, aes(x = log2(lncrna_peaks_observed / lncrna_peaks_expected), 
                            y = -log10(chisq_pval),
                            label = tf))
g2 + geom_point() + 
  ylim(0, 5)  + 
  xlim(-0.5, 0.5) +
  geom_text(data = subset(chisq_res, diff > 0)) +
  ggtitle("lncRNA vs mRNA binding enrichment") +
  xlab("log2(Obs/Exp)") +
  geom_hline(yintercept = -log10(0.05), lty = 2)
ggsave("figures/lncrna_vs_mrna_binding.pdf")
ggsave("figures/lncrna_vs_mrna_binding.png")
```

