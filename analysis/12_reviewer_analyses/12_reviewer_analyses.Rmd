---
title: "Reviewer_analyses"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE)
library(GenomicRanges)
library(rtracklayer)
library(tidyverse)
source("/Shares/rinn_class/data/CLASS_2020/analysis/util/_setup.R")
source("/Shares/rinn_class/data/CLASS_2020/analysis/util/intersect_functions.R")



# source("util/plotting_functions.R")
# source("util/intersect_functions.R")
# source("util/_setup.R")
```

```{r}

consensus_peaks <- create_consensus_peaks(broadpeakfilepath = "/Shares/rinn_class/data/k562_chip/results/bwa/mergedLibrary/macs/broadPeak")
# Filter based on number of peaks to be consistent with the previous data.
consensus_peaks <- consensus_peaks[sapply(consensus_peaks, length) > 250]


res_df <- read_csv("../08_defining_reservoirs/results/08_peak_occurence_df_resvoirs.csv")
all_promoters <-  rtracklayer::import("../01_consensus_peaks/results/lncrna_mrna_promoters.gtf")

```


```{r}
# Profile function
profile_tss <- function(peaks, 
                        promoters_gr,
                        upstream = 3e3,
                        downstream = 3e3) {
  

  peak_coverage <- coverage(peaks)
  
  coverage_length <- elementNROWS(peak_coverage)
  coverage_gr <- GRanges(seqnames = names(coverage_length),
                         IRanges(start = rep(1, length(coverage_length)), 
                                 end = coverage_length))
  
  promoters_gr <- subsetByOverlaps(promoters_gr, 
                                       coverage_gr, 
                                       type="within", 
                                       ignore.strand=TRUE)
  chromosomes <- intersect(names(peak_coverage), 
                           unique(as.character(seqnames(promoters_gr))))
  peak_coverage <- peak_coverage[chromosomes]
  
  promoters_ir <- as(promoters_gr, "IntegerRangesList")[chromosomes]
  
  promoter_peak_view <- Views(peak_coverage, promoters_ir)
  
  promoter_peak_view <- lapply(promoter_peak_view, function(x) t(viewApply(x, as.vector)))
  promoter_peak_matrix <- do.call("rbind", promoter_peak_view)
  
  minus_idx <- which(as.character(strand(promoters_gr)) == "-")
  promoter_peak_matrix[minus_idx,] <- promoter_peak_matrix[minus_idx,
                                                           ncol(promoter_peak_matrix):1]
  
  if(length(which(rowSums(promoter_peak_matrix) > 1)) > 1) {
    promoter_peak_matrix <- promoter_peak_matrix[rowSums(promoter_peak_matrix) > 1,]
    
    peak_sums <- colSums(promoter_peak_matrix)
    peak_dens <- peak_sums/sum(peak_sums)
    
    metaplot_df <- data.frame(x = -upstream:(downstream-1),
                              dens = peak_dens)
  } else if(length(which(rowSums(promoter_peak_matrix) > 1)) == 1) {
    promoter_peak_matrix <- t(as.matrix(promoter_peak_matrix[rowSums(promoter_peak_matrix) > 1,]))
    
    peak_sums <- colSums(promoter_peak_matrix)
    peak_dens <- peak_sums/sum(peak_sums)
    
    metaplot_df <- data.frame(x = -upstream:(downstream-1),
                              dens = peak_dens)
  } else {
    metaplot_df <- data.frame(x = -upstream:(downstream-1),
                              dens = 0)
  }
  
  return(metaplot_df)
}
```

```{r}
reservoirs <- res_df %>% filter(reservoir == 1)
nonres <- res_df %>% filter(reservoir == 0)
reservoir_prom <- all_promoters[all_promoters$gene_id %in% reservoirs$gene_id]
nonres_prom <- all_promoters[all_promoters$gene_id %in% nonres$gene_id]

profile_df <- data.frame("x" = integer(),
                         "dens" = numeric(),
                         "reservoir" = character(),
                         "dbp" = character())

for(i in 1:length(consensus_peaks)) {
  pks <- consensus_peaks[[i]]
  
  length(pks)
  reservoir_prof <- profile_tss(pks, reservoir_prom)
  nonres_prof <- profile_tss(pks, nonres_prom)
  
  # label 
  reservoir_prof$reservoir <- "reservoir"
  nonres_prof$reservoir <- "non-reservoir"
  
  reservoir_prof$dbp <- names(consensus_peaks)[i]
  nonres_prof$dbp <- names(consensus_peaks)[i]
  
  profile_df <- bind_rows(profile_df, reservoir_prof, nonres_prof)

  }

write_csv(profile_df, "results/reservoir_tss_metaplot_profile.csv")


```

```{r}
dbps <- unique(profile_df$dbp)


ggplot(profile_df, 
       aes(x = x, y = dens, color = reservoir)) + 
    geom_vline(xintercept = 0, lty = 2) + 
  geom_line(size = 1.5, alpha = 0.7) + 
  facet_wrap(~dbp) +
  ggtitle("Reservoir vs non-reservoir TSS profiles") + 
  scale_x_continuous(breaks = c(-3000, 0, 3000),
                     labels = c("-3kb", "TSS", "+3kb"),
                     name = "") + 
  ylab("Peak frequency") + 
  theme_paperwhite() + 
  scale_color_manual(values = c("#424242","#A8404C"))
ggsave("figures/tss_profile_reservoir_vs_nonres.pdf", height = 20, width = 20)

```







Hommer genome locations
```{r}

base_path <- paste0("/Shares/rinn_class/data/k562_chip/results/bwa/mergedLibrary/macs/broadPeak/consensus/")





```




