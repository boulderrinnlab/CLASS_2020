---
title: "Permutation analysis at repeat elements"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE)
library(tidyverse)
library(GenomicRanges)
source("../util/intersect_functions.R")
source("../util/_setup.R")
```

## Purpose: Determine statistical enrichment depletion of each peak set vs. sets of regions.

To determine if peaks are significantly enriched or depleted in each TE family/class, we will randomly shuffle the peaks around the genome and calculate the number of overlaps occuring by chance.

We've already done the permutation, which takes a long time to run, so here we are just reading in the permutation results to analyze.

```{r import}
#read in permutation results for TE classes and families
permutation_te_class <- read.csv("/Shares/rinn_class/data/k562_chip/analysis/11_peak_feature_intersect/results/permutation_results_repeat_classes.csv")

permutation_te_family <- read.csv("/Shares/rinn_class/data/k562_chip/analysis/11_peak_feature_intersect/results/permutation_results_repeat_families.csv")

```

Calculate z-score and p-value using the Fischer exact test for TE families:

```{r}
# First separate out the character numbers and change them back to numeric.
permutation_te_family_long <- permutation_te_family %>%
  separate_rows(permuted, sep = ";") %>%
  mutate(permuted = as.numeric(permuted))

# Okay, now let's calculate the zscore and pvalue.
# We're calculating the Fisher exact test here. We did 1000 permutations, so we will correct for that.
permutation_te_family_summary <- permutation_te_family_long %>% 
  group_by(region, tf) %>%
  summarize(observed = unique(observed),
            mean_permuted = mean(permuted),
            diff = observed - mean_permuted,
            alternative = ifelse(unique(observed) < mean(permuted), "less", "greater"),
            zscore = round((unique(observed) - mean(permuted))/stats::sd(permuted), 4),
            pval = ifelse(unique(alternative) == "less", (sum(unique(observed) >= permuted, na.rm = TRUE) + 1)/(1000 + 1),
                          (sum(unique(observed) <= permuted, na.rm = TRUE) + 1)/(1000 + 1)))

# Apply the Benjamini-Hochberg correction.
permutation_te_family_summary$padj <- p.adjust(permutation_te_family_summary$pval, method = "BH")

# Filter out any families with no z-scores.
permutation_te_family_summary <- filter(permutation_te_family_summary, zscore != "NaN")

```

Plot a clustered heatmap of overlaps at TE families: 

```{r}
# Cluster the rows and columns.
permutation_te_family_matrix <- permutation_te_family_summary %>%
  dplyr::select(tf, region, zscore) %>%
  pivot_wider(names_from = tf, values_from = zscore) %>%
  column_to_rownames("region") %>%
  as.matrix()

# Cluster by TE family
region_clust <- hclust(dist(permutation_te_family_matrix))

# Cluster by TF
tf_clust <- hclust(dist(t(permutation_te_family_matrix)))

# Factorize these columns according to the order which we specified.
permutation_te_family_summary$region <- factor(permutation_te_family_summary$region, region_clust$labels[region_clust$order])

permutation_te_family_summary$tf <- factor(permutation_te_family_summary$tf, tf_clust$labels[tf_clust$order])

# Make a heatmap of the results.
g <- ggplot(permutation_te_family_summary, aes(x = region, y = tf, fill = zscore))
g + geom_tile() + scale_fill_gradient2(limits = c(-100, 100)) + coord_flip() + 
  xlab("TE family") + ylab("TF") +
  theme(axis.text.x = element_text(angle = 90L, hjust = 1L, vjust = 0.5))
```

Figure 1: Heatmap of TF enrichment at TE families.

```{r}
ggsave("repeat_families_vs_tf_peaks.pdf", height = 10, width = 30)

```


Now calculate z-score and p-value using the Fischer exact test for TE classes:

```{r}
# First separate out the character numbers and change them back to numeric.
permutation_te_class_long <- permutation_te_class %>%
  separate_rows(permuted, sep = ";") %>%
  mutate(permuted = as.numeric(permuted))

# Okay, now let's calculate the zscore and pvalue.
# We're calculating the Fisher exact test here. We did 1000 permutations, so we will correct for that.
permutation_te_class_summary <- permutation_te_class_long %>% 
  group_by(region, tf) %>%
  summarize(observed = unique(observed),
            mean_permuted = mean(permuted),
            diff = observed - mean_permuted,
            alternative = ifelse(unique(observed) < mean(permuted), "less", "greater"),
            zscore = round((unique(observed) - mean(permuted))/stats::sd(permuted), 4),
            pval = ifelse(unique(alternative) == "less", (sum(unique(observed) >= permuted, na.rm = TRUE) + 1)/(1000 + 1),
                          (sum(unique(observed) <= permuted, na.rm = TRUE) + 1)/(1000 + 1)))

# Apply the Benjamini-Hochberg correction.
permutation_te_class_summary$padj <- p.adjust(permutation_te_class_summary$pval, method = "BH")

# Filter out any classes with no z-scores.
permutation_te_class_summary <- filter(permutation_te_class_summary, zscore != "NaN")

```

Plot a clustered heatmap of overlaps at TE classes: 

```{r}
# Cluster the rows and columns.
permutation_te_class_matrix <- permutation_te_class_summary %>%
  dplyr::select(tf, region, zscore) %>%
  pivot_wider(names_from = tf, values_from = zscore) %>%
  column_to_rownames("region") %>%
  as.matrix()

# Cluster by TE class
region_clust <- hclust(dist(permutation_te_class_matrix))

# Cluster by TF
tf_clust <- hclust(dist(t(permutation_te_class_matrix)))

# Factorize these columns according to the order which we specified.
permutation_te_class_summary$region <- factor(permutation_te_class_summary$region, region_clust$labels[region_clust$order])

permutation_te_class_summary$tf <- factor(permutation_te_class_summary$tf, tf_clust$labels[tf_clust$order])

# Make a heatmap of the results.
g <- ggplot(permutation_te_class_summary, aes(x = region, y = tf, fill = zscore))
g + geom_tile() + scale_fill_gradient2(limits = c(-100, 100)) + coord_flip() + 
  xlab("TE class") + ylab("TF") +
  theme(axis.text.x = element_text(angle = 90L, hjust = 1L, vjust = 0.5))
```

Figure 2: Heatmap of TF enrichment at TE classes.

```{r}
ggsave("repeat_classes_vs_tf_peaks.pdf", height = 8, width = 28)

```





