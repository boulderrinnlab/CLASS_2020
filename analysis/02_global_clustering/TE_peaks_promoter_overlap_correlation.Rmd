---
title: "Correlation between number of peaks and promoter overlaps"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(stringsAsFactors = FALSE)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(GenomicRanges)

#Get the functions necessary for this analysis
source("../util/intersect_functions.R")
source("../util/_setup.R")
```

The purpose of this code is to plot the correlation between the number of peaks for each TF and the number of peaks within lncRNA/mRNA promoters.

# Get a matrix of features by TFs.

```{r}
# Import the consensus peaks
#import_peaks is a function
peak_list <- import_peaks()

# Import the gencode annotation file
gencode_gr <- rtracklayer::import("/Shares/rinn_class/data/genomes/human/gencode/v32/gencode.v32.annotation.gtf")

# Get both the lncRNA and mRNA promoter regions
# get_promoter_regions is a function
lncRNA_proms <- get_promoter_regions(gencode_gr, biotype = ("lncRNA"))
mRNA_proms <- get_promoter_regions(gencode_gr, biotype = ("protein_coding"))

# Count the number of peaks in lncRNA and mRNA promoters
#count_peaks_per_feature is a function
lncRNA_promoter_peak_count <- count_peaks_per_feature(lncRNA_proms, peak_list)
mRNA_promoter_peak_count <- count_peaks_per_feature(mRNA_proms, peak_list)
```

```{r filtering}
# Make a binary co-occurence matrix where any number of peaks in a promoter for a tf is considered binding.
lncRNA_promoter_bound <- lncRNA_promoter_peak_count > 0
mRNA_promoter_bound <- mRNA_promoter_peak_count > 0

# Make this into a numeric vector (0 or 1)
lncRNA_promoter_occurence <- as.numeric(lncRNA_promoter_bound)
mRNA_promoter_occurence <- as.numeric(mRNA_promoter_bound)

# Make back into a matrix
lncRNA_promoter_peak_occurence <- matrix(lncRNA_promoter_occurence, 
                           nrow = dim(lncRNA_promoter_peak_count)[1],
                           ncol = dim(lncRNA_promoter_peak_count)[2])

mRNA_promoter_peak_occurence <- matrix(mRNA_promoter_occurence, 
                           nrow = dim(mRNA_promoter_peak_count)[1],
                           ncol = dim(mRNA_promoter_peak_count)[2])

# Let's transfer the row and column names
rownames(lncRNA_promoter_peak_occurence) <- rownames(lncRNA_promoter_peak_count)
colnames(lncRNA_promoter_peak_occurence) <- colnames(lncRNA_promoter_peak_count)

rownames(mRNA_promoter_peak_occurence) <- rownames(mRNA_promoter_peak_count)
colnames(mRNA_promoter_peak_occurence) <- colnames(mRNA_promoter_peak_count)
```

Plot the correlation between the number of consensus peaks and the number of peaks overlapping promoters.

```{r}

# Get the number of peaks per TF
num_peaks <- sapply(peak_list, length)

# Get the number peaks that overlap promoters per TF
lncRNA_num_prom_overlap <- rowSums(lncRNA_promoter_peak_count)
mRNA_num_prom_overlap <- rowSums(mRNA_promoter_peak_count)

# Make a data frame of promoter overlaps
lncRNA_prom_overlap_df <- data.frame("peaks_overlapping_promoters" = lncRNA_num_prom_overlap,
                              "peaks_per_TF" = num_peaks)
mRNA_prom_overlap_df <- data.frame("peaks_overlapping_promoters" = mRNA_num_prom_overlap,
                              "peaks_per_TF" = num_peaks)
```

Plot the correlation between the number of peaks per TF and the number of peaks in mRNA and lncRNA promoters.

```{r}

ggplot(mRNA_prom_overlap_df,
       aes(x = peaks_per_TF, y = peaks_overlapping_promoters)) +
  geom_point() + 
  geom_smooth(method = "lm")
```

Figure 1. ...



