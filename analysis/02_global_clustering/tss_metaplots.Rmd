---
title: "TSS profiles: plotting & clustering"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(stringsAsFactors = FALSE)
knitr::opts_chunk$set(echo = TRUE)
# library(rtracklayer)
library(GenomicRanges)
# library(ChIPseeker)
library(boot)
# library(GenomicFeatures)
library(tidyverse)
library(pheatmap)
source("../util/intersect_functions.R")
source("../util/_setup.R")
```

```{r import}
lncrna_mrna_promoters <- rtracklayer::import("../01_consensus_peaks/results/lncrna_mrna_promoters.gtf")
lncrna_promoters <- rtracklayer::import("../01_consensus_peaks/results/lncrna_promoters.gtf")
mrna_promoters <- rtracklayer::import("../01_consensus_peaks/results/mrna_promoters.gtf")

consensus_peaks <- import_peaks("../01_consensus_peaks/results/consensus_peaks/")
```

```{r create-profiles}
tag_count_df <- data.frame("pos" = integer(0),
                           "value" = numeric(0),
                           "Lower" = numeric(0),
                           "Upper" = numeric(0),
                           "dbp" = character(0))
for (i in 1:length(consensus_peaks)) {
  if(i %% 10 == 0) { print(i) }
    tag_matrix <- get_tag_matrix(consensus_peaks[[i]], windows=lncrna_mrna_promoters)
    tag_count <- get_tag_count(tag_matrix, xlim=c(-3000, 3000), conf = 0.95, ncpus = 6)
    tag_count$dbp <- names(consensus_peaks)[i]
    
    tag_count_df <- bind_rows(tag_count_df, tag_count)
}
write_csv(tag_count_df, "results/tss_profiles.csv")
```

```{r profile-clustering}
tcm <- tag_count_df %>%
  dplyr::select(pos, value, dbp) %>%
  pivot_wider(names_from = pos, values_from = value) %>%
  column_to_rownames("dbp") %>%
  as.matrix()
tmp_hclust <- hclust(dist(tcm))
tcmz <- t(scale(t(tcm)))
pheatmap(tcmz, cluster_cols = FALSE)
```

```{r representative-profiles}

```

```{r example-profiles}

```




