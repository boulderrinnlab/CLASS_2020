---
title: "10_reservoir_binding_properties"
author: "JR"
date: "5/29/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("../util/intersect_functions.R")
source("../util/_setup.R")
library(GenomicRanges)
library(tidyverse)
library(effectsize)
```




# loading in peaks and promoter annotations to ulitmately make the "peak_occurence_df"

```{r}
# Read in reservoir annotations combined with promoter peak occurence df. 
peak_occurrence_df <- read_csv("../07_binding_versus_expression/results/peak_tpm_occurence_df.csv")
reservoir_occurence_df <- read_csv("results/k562_reservoir_promoters_info.csv")

# adding in expression to peak_occurence_df with a new observation "expressed" off < 0.001 TPM and on > 0.001 TPM.
peak_occurrence_df[which(peak_occurrence_df$tpm > 0.001), "expression"] <- "expressed"
peak_occurrence_df[which(peak_occurrence_df$tpm < 0.001), "expression"] <- "off"
```


# We are setting up to look at the binding distribution on expressed lncRNA and mRNA vs reservoir mRNA lncRNA binding. 
#1 Distribution of reservoir vs all subsetted by lncRNA and mRNA
Figure 4C
```{r}
# Let's look at distribution of binding events to filter on those that have more than typical numbers of DBPs bound to promoter.
# first reverting back into a data frame with specific columns 
g <- ggplot(peak_occurrence_df, aes(x = number_of_tfs))
g + geom_histogram(binwidth = 5)  + 
  xlim(30, 100) +
  facet_wrap(expression~gene_type, scales = "free_y")

ggsave("figures/exp_not_exp_binding_histogram.png")
ggsave("figures/exp_not_exp_binding_histogram.pdf")



```
##We find that expressed or not expressed promoters still have similar distributions of DBP binding events. With some non-expressed promoters containing 100 independent DBP localization events. 


#2 Chi-Squared test for DBPs enriched and depleted at reservoirs versus non-reservoir promoters.
```{r}

#lncrna_num_overlaps <- rowSums(lncrna_matrix)
#mrna_num_overlaps <- rowSums(mrna_matrix)
num_peaks <- sapply(peak_list, length)
#total_lncrna <- length(lncrna_promoters)
#total_mrna <- length(mrna_promoters)
#total_genes <- total_lncrna + total_mrna



res_matrix <- count_peaks_per_feature(reservoir_promoters, peak_list, type = "occurrence")
total_prom_matrix <- count_peaks_per_feature(promoters, peak_list, type = "occurrence")

res_overlap <- rowSums(res_matrix)
total_prom_overlap <- rowSums(total_prom_matrix)
total_res <- length(reservoir_promoters)
total_proms <- length(promoters)


chisq_res <- data.frame("tf" =character(),
                        "reservoir_peaks_observed" = numeric(),
                        "chisq_stat" = numeric(),
                        "chisq_pval" = numeric(),
                        "reservoir_peaks_expected" = numeric())
for(i in 1:length(num_peaks)) {
  total_peaks <- num_peaks[[i]]
  df1 <- data.frame("gene_type" = c("reservoir","reservoir", "total_promoters", "total_promoters"),
                    "promoter_bound" = c("bound", "not_bound", "bound", "not_bound"),
                    "count" = c(res_overlap[[i]],
                                total_proms - res_overlap[[i]],
                                total_prom_overlap[[i]],
                                total_proms - res_overlap[[i]])) %>%
    pivot_wider(names_from = gene_type, values_from = count) %>%
    column_to_rownames("promoter_bound") %>%
    as.matrix()
  
  csres <- chisq.test(df1)
  
  
  phi_coef <- phi(df1)
  
  tdf <- data.frame("tf" = names(num_peaks[i]),
                    "lncrna_peaks_observed" = res_overlap[[i]],
                    "chisq_stat" = csres$statistic,
                    "chisq_pval" = csres$p.value,
                    "reservoir_peaks_expected" = csres$expected[1,1],
                    "phi_coefficient" = phi_coef$phi)
  chisq_res <- bind_rows(chisq_res, tdf)
}


#Adjusting P value with BH correction, observed - expected and writing this to a .csv file

chisq_res$padj <- p.adjust(chisq_res$chisq_pval, method = "BH")
chisq_res$diff <- chisq_res$reservoir_peaks_observed - chisq_res$reservoir_peaks_expected
write_csv(chisq_res, "results/reservoir_chi_squared_results.csv")


#Plotting Chi-squared test results 
g <- ggplot(chisq_res, aes(x = diff, y = -log10(chisq_pval) ))
g + geom_point()  


```
# This makes figure 4D showing that most DBPs are depleted from resevoirs and the enrichment of several factors on reservoirs.









# 3 Pol II reservoirs versus Pol II negative reservoirs
```{r}
#PolR2A and PolR2B had the same overlap profile with reservoirs so we only used PolR2A

reservoir_genes <- gsub("_promoter_tss6kb", "", reservoir_promoters$name)
polr2a <- peak_list$POLR2A
pol2_occurence <- matrix(0, nrow = length(reservoir_promoters), ncol = 1)
polr2a_ov <- findOverlaps(reservoir_promoters, polr2a)
polr2a_res_overlaps <- unique(polr2a_ov@from)
pol2_occurence[polr2a_res_overlaps,] <- 1
rownames(pol2_occurence) <- reservoir_genes
colnames(pol2_occurence) <- c("Polr2a")



# Make a data frame of binding events per promoter.
pol2_occurence_df <- data.frame("GeneID" = rownames(pol2_occurence),
                                "pol2_number_bound" = rowSums(pol2_occurence))
#make yes or no
pol2 <- data.frame("Pol2" = as.character())
for (i in 1:nrow(pol2_occurence_df)) {
  if (pol2_occurence_df$pol2_number_bound[[i]] > 0) {
    temp_df <- data.frame("GeneID" = pol2_occurence_df$GeneID[[i]], "Pol2" = "yes")
  }
    else{
      temp_df <- data.frame("GeneID" = pol2_occurence_df$GeneID[[i]], "Pol2" = "no")
    }
    pol2 <- bind_rows(temp_df, pol2)
}



#TODO 
sum_df <- data.frame("Pol2" = sum(str_count(Pol2, pattern = "yes")))
rownames(sum_df) <- "Number_reservoirs"
#Save Overlap Table as CSV
write.csv(sum_df, "results/histone_marks_se_pol2.csv")



#TODO Chisquared










  
```














# Clustering

```{r}
# Calculate a distance measure between the rows.
bin_hier <- hclust(dist(ghost_peak_occurence, method = "binary"))
plot(bin_hier)
# load library for ggdendro for the best trees we could find 
library(ggdendro)
ggdendro::ggdendrogram(bin_hier, rotate = TRUE,  size = 3)
ggsave("figures/ghost_binary_dist.pdf", height = 26, width = 6)
```
```

