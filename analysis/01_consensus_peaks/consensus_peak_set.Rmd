
---
title: "Final Consensus Peaks File"
author: "JR & Michael"
date: "3/7/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE)
library(GenomicRanges)
library(rtracklayer)
library(tidyverse)
source("/Shares/rinn_class/data/CLASS_2020/analysis/util/_setup.R")
source("/Shares/rinn_class/data/CLASS_2020/analysis/util/intersect_functions.R")
```


# Purpose: Create consensus peak sets
# Here we'd just like to take the replicate files per TF and create one peak set per TF with the subset of peaks that had an 
# overlapping peak in all replicates. 

```{r}

consensus_peaks <- create_consensus_peaks(broadpeakfilepath = "/Shares/rinn_class/data/k562_chip/results/bwa/mergedLibrary/macs/broadPeak")

num_peaks <- sapply(consensus_peaks, length)


# We're going toconsensus_peaks apply a cutoff at 250 peaks
consensus_peaks <- consensus_peaks[num_peaks > 250]


# Export the peak lists.
for(i in 1:length(consensus_peaks)) {
  rtracklayer::export(consensus_peaks[[i]], paste0("results/", names(consensus_peaks)[i], "_consensus_peaks.bed"))
}

```

```{r}


fl <- list.files("results/", full.names = T)
peak_summary <- data.frame("TF" = character(),
                           "numpeaks" = numeric(), 
                           "peak_length" = numeric())
tfs <- sapply(fl, function(x) {
  unlist(strsplit(unlist(strsplit(x,"//"))[[2]], "_"))[[1]]
})
for(i in 1:length(fl)) {
peaks <- rtracklayer::import(fl[i], format = "bed")
num_peaks <- length(peaks)
peak_length <- sum(width(peaks))
peak_summary <- bind_rows(peak_summary,
                          data.frame("TF" =tfs[i],
                                     "numpeaks" = num_peaks,
                                     "peak_length" = peak_length))


}
```


#Plotting
```{r}
g <- ggplot(peak_summary, aes(x = numpeaks, y = peak_length, label = TF))
g + geom_point() + 
  ylab("BP covered") +
  xlab("Number of peaks") + 
  geom_text()
```

```{r}
fl <- list.files("results", full.names = T)
peak_info <- data.frame("TF" = character(),
                        "peak_size" = numeric())
for(i in 1:length(fl)) {
  peaks <- rtracklayer::import(fl[i])
  peak_size <- width(peaks)
  if(length(peak_size) > 0) {
      peak_info <- bind_rows(peak_info,
                          data.frame("TF" =unique_tf[[i]],
                                     "peak_size" = peak_size))
  }
}
```


```{r}
tfs_to_plot <- c("POLR2A", "ARID1B", "SUPT5H", "eGFP-ZNF512")
g <- ggplot(peak_info %>% filter(TF %in% tfs_to_plot), aes(x = log10(peak_size), fill = TF))
g + geom_density(alpha = 0.2)
peak_size_summary <- peak_info %>% group_by(TF) %>%
  summarize("mean_size" = mean(peak_size), "sd_size" = sd(peak_size))
g <- ggplot(peak_size_summary, aes(x = log10(mean_size), y = log10(sd_size), label = TF))
g + geom_point()+geom_text()
```
